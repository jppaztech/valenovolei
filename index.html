<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üèê Peladas Vale no V√¥lei</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --muted:#9aa4b2; --text:#eef2f6; --accent:#22c55e;
    --danger:#ef4444; --warn:#f59e0b; --ring:#2a3242; --gap:14px; --radius:14px;
    --small:0.9rem;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Inter', system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      background:var(--bg);color:var(--text);line-height:1.35}
  header{padding:14px 16px;border-bottom:1px solid #1f2430;background:#0c0e13;position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:1.15rem}
  main{padding:12px;display:grid;gap:var(--gap);max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid #2a3242;border-radius:var(--radius);padding:12px}
  .row{display:grid;gap:8px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:720px){
    .row.cols-2{grid-template-columns:1fr}
    .row.cols-3{grid-template-columns:1fr}
  }
  label{font-size:var(--small);color:var(--muted)}
  input[type="text"], input[type="number"], select{
    width:100%;padding:10px;background:#0e121a;border:1px solid #293042;border-radius:10px;color:var(--text);
    font-size:1rem
  }
  input[type="number"]{text-align:center}
  button{
    width:100%;padding:12px;border:0;border-radius:10px;background:var(--accent);color:#08140c;font-weight:700;
    font-size:1rem;cursor:pointer
  }
  button:disabled{background:#2b3344;color:#9aa4b2;cursor:not-allowed;}
  button.small{padding:6px 10px;font-size:.85rem;width:auto}
  button.secondary{background:#2b3344;color:#d9e1ea}
  button.warn{background:var(--warn);color:#201600}
  .team-block{border:1px dashed #2a3346;border-radius:12px;padding:10px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0d1118;border:1px solid #283244}
  .dot{width:12px;height:12px;border-radius:50%}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0b0e14;border:1px solid #293042;
      padding:2px 6px;border-radius:6px;color:#ffffff}
  .status{padding:10px 12px;border:1px solid #2a3242;border-radius:10px;background:#10141c;color:#dbe5f2}
  .status.good{border-color:#1f6e3b;background:#0f1a13}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .podium{display:grid;gap:8px}
  .hidden{display:none !important}
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  th,td{padding:8px;border-bottom:1px solid #16202a;text-align:left}
  th{color:var(--muted);font-weight:700}
  .right{text-align:right}
  .mini{font-size:.85rem;color:var(--muted)}
  .badge{padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #25303e;color:#9aa4b2;font-size:.85rem}
  .players-list{margin-top:4px;font-size:0.85rem;color:var(--muted)}
  .score-grid{display:grid;grid-template-columns:1fr 140px 1fr;gap:8px;align-items:end}
  .score-grid .vs{justify-self:center;color:var(--muted)}
  .team-side{display:flex;flex-direction:column;gap:6px}
  .players-list ul{margin:4px 0 0;padding:0;list-style:none;font-size:0.85rem;color:var(--muted)}
  .score-input-group{display:flex;align-items:center;gap:4px}
  .score-input-group input{border-radius:0}
  .score-input-group button{width:36px;padding:10px 0;font-size:1.1rem;border-radius:0}
  .score-input-group button:first-of-type{border-radius:10px 0 0 10px}
  .score-input-group button:last-of-type{border-radius:0 10px 10px 0}
  .game-editor{margin-top:8px;padding-top:8px;border-top:1px dashed #2a3346;display:grid;grid-template-columns:1fr 1fr 80px;gap:8px}
  .button-group{display:grid; grid-auto-flow: column; gap: 8px;}
  .agenda-game{border-bottom: 1px solid #2a3242; padding-bottom: 8px; margin-bottom: 8px;}
  .agenda-game:last-child{border-bottom:0; margin-bottom:0; padding-bottom:0;}
  #export-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;display:flex;justify-content:center;align-items:center;font-size:1.5rem;z-index:9999;}
</style>
</head>
<body>
<header><h1>üèê Peladas Vale no V√¥lei</h1></header>

<main>
  <section id="setup" class="card">
    <h2>1) Cadastro</h2>
    <div id="stepParams">
      <div class="row cols-3">
        <div><label>Jogadores</label><input id="numPlayers" type="number" min="2" placeholder="Ex.: 12" /></div>
        <div><label>Times</label><input id="numTeams" type="number" min="3" placeholder="Ex.: 4" /></div>
        <div><label>Rodadas</label><input id="numRounds" type="number" min="1" placeholder="Ex.: 4" /></div>
      </div>
      <div class="row button-group" style="margin-top:14px">
        <button id="resetParamsBtn" class="warn">Reset</button>
        <button id="toPlayersBtn">Pr√≥ximo</button>
      </div>
    </div>
    <div id="stepPlayers" class="hidden">
      <div class="flex" style="justify-content:space-between"><b>Jogadores</b><span class="badge">Habilidade 1 a 5 ‚≠ê</span></div>
      <div id="playersForm" class="row cols-2" style="margin-top:8px"></div>
      <div class="row button-group" style="margin-top:14px">
        <button id="resetPlayersBtn" class="warn">Reset</button>
        <button id="backToParamsBtn" class="secondary">Voltar</button>
        <button id="toTeamsBtn">Pr√≥ximo</button>
      </div>
    </div>
    <div id="stepTeams" class="hidden">
      <div class="flex" style="justify-content:space-between"><b>Times</b><span class="badge">Nomes dos times</span></div>
      <div id="teamsForm" class="row cols-2" style="margin-top:8px"></div>
       <div class="row button-group" style="margin-top:14px">
        <button id="resetTeamsBtn" class="warn">Reset</button>
        <button id="backToPlayersBtn" class="secondary">Voltar</button>
        <button id="toPreviewBtn">Pr√≥ximo</button>
      </div>
    </div>
    <div id="stepTeamPreview" class="hidden">
      <div class="flex" style="justify-content:space-between"><b>Times Sorteados</b><span class="badge">Distribui√ß√£o equilibrada</span></div>
      <div id="previewBox" style="margin-top:8px"><div id="previewContent" class="row"></div></div>
      <div class="row button-group" style="margin-top:12px; grid-template-columns: 1fr 1fr 2fr;">
        <button id="exportTeamsJpegBtn" class="secondary">JPEG</button>
        <button id="exportTeamsPdfBtn" class="secondary">PDF</button>
        <button id="startMatchesBtn">Iniciar pelada</button>
      </div>
      <div class="row" style="margin-top:8px"><button id="backToTeamsFromPreviewBtn" class="secondary">Voltar</button></div>
    </div>
  </section>
  <section id="matches" class="card hidden">
    <h2>2) Rodadas</h2>
    <div id="roundInfo" class="status">Rodada 1</div>
    <div id="currentMatch" class="card" style="margin:12px 0"></div>
    <div class="card" style="margin-bottom:12px">
      <b>Classifica√ß√£o ao vivo</b>
      <div class="mini muted">Atualiza automaticamente.</div>
      <div style="margin-top:8px;overflow:auto">
        <table id="standingsTable">
          <thead>
            <tr><th>Time</th><th class="right">J</th><th class="right">V</th><th class="right">D</th><th class="right">PF</th><th class="right">PS</th><th class="right">Saldo</th><th class="right">% de vit√≥ria</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="row button-group" style="margin-bottom:12px">
        <button id="saveOnlyBtn">Salvar Placar</button>
        <button id="nextMatchBtn" class="secondary" disabled>Pr√≥xima Partida</button>
    </div>
    <div style="display: flex; align-items: flex-start; gap: 16px;">
        <details style="flex-grow: 1;">
          <summary>Agenda completa ‚Äî editar placares</summary>
          <div id="agenda" style="margin-top:8px"></div>
        </details>
        <div style="display: flex; flex-direction: column; gap: 4px; flex-shrink:0;">
            <button id="exportAgendaJpegBtn" class="small secondary">JPEG</button>
            <button id="exportAgendaPdfBtn" class="small secondary">PDF</button>
        </div>
    </div>
    <div class="row button-group" style="margin-top:12px">
        <button id="backToPreviewBtn" class="secondary">Voltar</button>
        <button id="goToHomeBtn" class="warn">In√≠cio</button>
    </div>
  </section>
  <section id="finals" class="card hidden">
    <h2>3) Finais</h2>
    <div class="mini muted">Padr√£o: 4 times (1¬∫x2¬∫, 3¬∫x4¬∫); 3 times (1¬∫x2¬∫).</div>
    <div id="finalsMatch" style="margin-top:8px"></div>
    <div class="row button-group" style="margin-top:12px">
        <button id="backToMatchesBtn" class="secondary">Voltar</button>
        <button id="saveFinalBtn">Salvar ‚ûú Pr√≥xima</button>
    </div>
  </section>
  <section id="podium" class="card hidden">
    <h2>4) P√≥dio</h2>
    <div id="podiumBox" class="podium"></div>
    <div class="row button-group" style="margin-top:10px; grid-template-columns: 1fr 1fr;">
        <button id="exportFullJpegBtn" class="secondary">Relat√≥rio (JPEG)</button>
        <button id="exportFullPdfBtn" class="secondary">Relat√≥rio (PDF)</button>
    </div>
    <div class="row" style="margin-top:8px">
        <button id="newTournamentBtn" class="warn">Novo torneio</button>
    </div>
    <div class="row" style="margin-top:12px"><button id="backToFinalsBtn" class="secondary">Voltar</button></div>
  </section>
</main>

<script>
(function(){
  const STORAGE_KEY = 'voleiPeladaState_v16_stable';
  const TEAM_COLORS = ["#ef4444","#22c55e","#3b82f6","#eab308","#a855f7","#06b6d4","#f97316","#84cc16"];
  let state = { numPlayers:0, numTeams:0, numRounds:0, players:[], teams:[], schedule:[], currentIndex:0, finals:[], finalsIndex:0, _rankingSnapshot: null };
  const el = id => document.getElementById(id);

  // --- M√ìDULO DE PERSIST√äNCIA ---
  function saveState() {
    let uiState = { visibleSection: '', visibleStep: '' };
    for (const section of document.querySelectorAll('main > section')) {
        if (!section.classList.contains('hidden')) {
            uiState.visibleSection = section.id;
            if (section.id === 'setup') {
                for (const step of document.querySelectorAll('#setup > div[id]')) {
                    if (step.id && !step.classList.contains('hidden')) { uiState.visibleStep = step.id; break; }
                }
            }
            break;
        }
    }
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ appState: state, ui: uiState })); }
    catch (e) { console.error("Falha ao salvar o estado.", e); }
  }
  function loadState() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (!savedData) return;
    try {
      const data = JSON.parse(savedData);
      if (data && data.appState && data.ui) {
        state = data.appState;
        rehydrateUI(data.ui);
      }
    } catch (e) { console.error("Falha ao carregar estado salvo.", e); localStorage.removeItem(STORAGE_KEY); }
  }
  function rehydrateUI(ui) {
    if (!ui || !ui.visibleSection) return;
    document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
    const section = el(ui.visibleSection);
    if (section) section.classList.remove('hidden');
    if (ui.visibleSection === 'setup' && ui.visibleStep) {
        document.querySelectorAll('#setup > div[id]').forEach(d => d.classList.add('hidden'));
        const step = el(ui.visibleStep);
        if (step) step.classList.remove('hidden');
        el('numPlayers').value = state.numPlayers || '';
        el('numTeams').value = state.numTeams || '';
        el('numRounds').value = state.numRounds || '';
        if(ui.visibleStep === 'stepPlayers') renderPlayersForm();
        if(ui.visibleStep === 'stepTeams') renderTeamsForm();
        if(ui.visibleStep === 'stepTeamPreview') renderTeamPreview();
    } else if (ui.visibleSection === 'matches') {
        atualizarClassificacao();
        renderAgenda();
        renderCurrentMatch();
    } else if (ui.visibleSection === 'finals') {
        renderFinalMatch();
    } else if (ui.visibleSection === 'podium') {
        buildPodium();
    }
  }
  function clearStateAndReload() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
  
  // --- NAVEGA√á√ÉO E L√ìGICA DE CADASTRO ---
  el("toPlayersBtn").addEventListener("click", () => {
    const numPlayers = parseInt(el("numPlayers").value, 10);
    const numTeams = parseInt(el("numTeams").value, 10);
    const numRounds = parseInt(el("numRounds").value, 10);
    if (!numPlayers || !numTeams || !numRounds || numPlayers < 2 || numTeams < 3 || numRounds < 1) {
        alert("Preencha todos os campos corretamente. M√≠nimo: 2 jogadores, 3 times, 1 rodada."); return;
    }
    state.numPlayers = numPlayers; state.numTeams = numTeams; state.numRounds = numRounds;
    renderPlayersForm();
    el('stepParams').classList.add('hidden');
    el('stepPlayers').classList.remove('hidden');
    saveState();
  });
  el("toTeamsBtn").addEventListener("click", () => {
    state.players = [];
    for (let i = 0; i < state.numPlayers; i++) {
        const name = el(`pl_name_${i}`).value.trim();
        const skill = parseInt(el(`pl_skill_${i}`).value, 10);
        if (!name) { alert(`Informe o nome do Jogador ${i + 1}.`); return; }
        state.players.push({ name, skill });
    }
    renderTeamsForm();
    el('stepPlayers').classList.add('hidden');
    el('stepTeams').classList.remove('hidden');
    saveState();
  });
  el("toPreviewBtn").addEventListener("click", () => {
    state.teams = [];
    for (let t = 0; t < state.numTeams; t++) {
        const name = el(`teamName_${t}`).value.trim() || `Time ${t + 1}`;
        state.teams.push({ name, color: TEAM_COLORS[t % TEAM_COLORS.length], players: [], stats: {} });
    }
    distribuirPorSomaEquilibrada();
    renderTeamPreview();
    el('stepTeams').classList.add('hidden');
    el('stepTeamPreview').classList.remove('hidden');
    saveState();
  });
  el("startMatchesBtn").addEventListener("click", () => {
    gerarAgendaRoundRobinRespeitandoRodadas();
    el('setup').classList.add('hidden');
    el('matches').classList.remove('hidden');
    atualizarClassificacao();
    renderAgenda();
    renderCurrentMatch();
    saveState();
  });

  el("backToParamsBtn").addEventListener("click", () => { el('stepPlayers').classList.add('hidden'); el('stepParams').classList.remove('hidden'); saveState(); });
  el("backToPlayersBtn").addEventListener("click", () => { el('stepTeams').classList.add('hidden'); el('stepPlayers').classList.remove('hidden'); saveState(); });
  el("backToTeamsFromPreviewBtn").addEventListener("click", () => { el('stepTeamPreview').classList.add('hidden'); el('stepTeams').classList.remove('hidden'); saveState(); });
  el("backToPreviewBtn").addEventListener("click", () => {
    el('matches').classList.add('hidden');
    el('setup').classList.remove('hidden');
    document.querySelectorAll('#setup > div[id]').forEach(d => d.classList.add('hidden'));
    el('stepTeamPreview').classList.remove('hidden');
    saveState();
  });
  
  el("resetParamsBtn").addEventListener("click", () => { el("numPlayers").value = ""; el("numTeams").value = ""; el("numRounds").value = ""; });
  el("resetPlayersBtn").addEventListener("click", () => renderPlayersForm());
  el("resetTeamsBtn").addEventListener("click", () => renderTeamsForm());
  el("goToHomeBtn").addEventListener("click", clearStateAndReload);
  el("newTournamentBtn").addEventListener("click", clearStateAndReload);

  // --- FUN√á√ïES DE RENDERIZA√á√ÉO DE UI ---
  function renderPlayersForm() {
    const pf = el("playersForm"); pf.innerHTML = "";
    for(let i=0; i<state.numPlayers; i++){
      pf.innerHTML += `<div class="team-block"><div class="row cols-2"><div><label>Jogador ${i+1}</label><input type="text" id="pl_name_${i}" placeholder="Nome"/></div><div><label>Habilidade (1‚Äì5 ‚≠ê)</label><select id="pl_skill_${i}"><option value="1">1 ‚≠ê</option><option value="2">2 ‚≠ê‚≠ê</option><option value="3" selected>3 ‚≠ê‚≠ê‚≠ê</option><option value="4">4 ‚≠ê‚≠ê‚≠ê‚≠ê</option><option value="5">5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option></select></div></div></div>`;
    }
  }
  function renderTeamsForm() {
    const tf = el("teamsForm"); tf.innerHTML = "";
    for(let t=0; t<state.numTeams; t++){
      const color = TEAM_COLORS[t % TEAM_COLORS.length];
      tf.innerHTML += `<div class="team-block"><div class="flex"><div class="chip"><span class="dot" style="background:${color}"></span><b>Time ${t+1}</b></div></div><div class="row" style="margin-top:8px"><label>Nome do time</label><input id="teamName_${t}" type="text" placeholder="Nome do time"/></div></div>`;
    }
  }
  function renderTeamPreview() {
    const container = el("previewContent"); container.innerHTML = "";
    state.teams.forEach(team => {
        const totalSkill = team.players.reduce((s, p) => s + p.skill, 0);
        container.innerHTML += `<div class="team-block"><div class="chip"><span class="dot" style="background:${team.color}"></span><b style="color:${team.color}">${team.name} (${totalSkill}‚≠ê)</b></div>${renderPlayersList(team.players)}</div>`;
    });
  }

  // --- M√ìDULO DE EXPORTA√á√ÉO ---
  function exportAsJpeg(htmlContent, filename, options = {}) {
    const overlay = document.createElement('div');
    overlay.id = 'export-overlay';
    overlay.innerText = 'Preparando imagem...';
    document.body.appendChild(overlay);

    const iframe = document.createElement('iframe');
    iframe.style.position = 'absolute';
    iframe.style.left = '-9999px';
    iframe.style.border = 'none';
    iframe.style.width = options.width || '800px';
    iframe.style.height = '1px'; // Apenas para garantir que seja renderizado
    document.body.appendChild(iframe);

    iframe.contentWindow.document.open();
    iframe.contentWindow.document.write(htmlContent);
    iframe.contentWindow.document.close();

    const onIframeLoad = () => {
        const targetElement = iframe.contentWindow.document.body;
        html2canvas(targetElement, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: options.dark ? '#0f1115' : '#ffffff',
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL("image/jpeg", 0.92);
            link.click();
            document.body.removeChild(iframe);
            document.body.removeChild(overlay);
        }).catch(err => {
            console.error("Falha na exporta√ß√£o para JPEG:", err);
            document.body.removeChild(iframe);
            document.body.removeChild(overlay);
            alert("Ocorreu um erro ao gerar a imagem.");
        });
    };

    // Adiciona um pequeno timeout para garantir que o conte√∫do do iframe seja processado
    setTimeout(() => {
      if (iframe.contentWindow.document.readyState === 'complete' || iframe.contentWindow.document.readyState === 'interactive') {
          onIframeLoad();
      } else {
          iframe.onload = onIframeLoad;
      }
    }, 500);
  }
  
  el("exportTeamsPdfBtn").addEventListener("click", () => {
    const style = `<style>body{font-family: Inter, sans-serif; background: #0f1115; color: #eef2f6; padding: 15px;} h1{color: #FFFFFF; font-size: 1.5rem; margin-bottom: 20px;} .team-block{border: 1px dashed #2a3346; border-radius: 12px; padding: 10px; margin-bottom: 12px; page-break-inside: avoid;} .chip{display:flex; align-items:center; gap:8px;} .dot{width:12px; height:12px; border-radius:50%;} b{font-weight:600;} ul{margin:4px 0 0; padding:0; list-style:none; font-size:0.85rem; color:#9aa4b2;}</style>`;
    let bodyHtml = '<h1>Escala√ß√£o dos Times</h1>';
    state.teams.forEach(team => {
        const totalSkill = team.players.reduce((s, p) => s + p.skill, 0);
        const playersHtml = team.players.map(p => `<li>${p.name} (${p.skill}‚≠ê)</li>`).join('');
        bodyHtml += `<div class="team-block"><div class="chip"><span class="dot" style="background:${team.color}"></span><b style="color:${team.color}; font-size:1.1rem;">${team.name} (${totalSkill}‚≠ê)</b></div><ul>${playersHtml}</ul></div>`;
    });
    const fullHtml = `<!DOCTYPE html><html><head><meta charset="utf-8">${style}</head><body>${bodyHtml}</body></html>`;
    html2pdf().set({ margin: 10, filename: 'escalacao_times_volei.pdf', jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(fullHtml).save();
  });
  el("exportTeamsJpegBtn").addEventListener("click", () => {
     const style = `<style>
        body{font-family: Inter, sans-serif; background: #0f1115; color: #eef2f6; padding: 15px; width: 500px;}
        h1{color: #FFFFFF; font-size: 1.5rem; margin-bottom: 20px;}
        .team-block{border: 1px dashed #2a3346; border-radius: 12px; padding: 10px; margin-bottom: 12px; background: #171a21;}
        .chip{display:flex; align-items:center; gap:8px;}
        .dot{width:12px; height:12px; border-radius:50%;}
        b{font-weight:600; color: #eef2f6;}
        ul{margin:8px 0 0; padding:0; list-style:none; font-size:0.85rem; color:#9aa4b2;}
      </style>`;
     let bodyHtml = '<h1>Escala√ß√£o dos Times</h1>';
     state.teams.forEach(team => {
        const totalSkill = team.players.reduce((s, p) => s + p.skill, 0);
        const playersHtml = team.players.map(p => `<li>${p.name} (${p.skill}‚≠ê)</li>`).join('');
        bodyHtml += `<div class="team-block"><div class="chip"><span class="dot" style="background:${team.color}"></span><b style="color:${team.color}; font-size:1.1rem;">${team.name} (${totalSkill}‚≠ê)</b></div><ul>${playersHtml}</ul></div>`;
     });
     const fullHtml = `<!DOCTYPE html><html><head><meta charset="utf-8">${style}</head><body>${bodyHtml}</body></html>`;
     exportAsJpeg(fullHtml, 'escalacao_times.jpeg', {dark: true, width: '530px'});
  });
  
  function getAgendaExportHtml() {
      const style = `<style>
        body{font-family: Inter, sans-serif; background: #0f1115; color: #eef2f6; padding: 10px;}
        h1{color: #FFFFFF; font-size: 1.1rem; margin-bottom: 10px;}
        .card{background:#171a21; border:1px solid #2a3242; border-radius:8px; padding:6px; margin-bottom:6px; page-break-inside: avoid;}
        .card > b {display:block; font-size: .8rem; margin-bottom: 4px;}
        .game{border-top: 1px solid #2a3242; padding-top: 5px; margin-top: 5px;}
        .game-info{display: flex; justify-content: space-around; align-items: center; font-size: 8pt;}
        .players-box{margin-top: 5px; border-top: 1px dashed #2a3242; padding-top: 5px; font-size: 6pt; color: #9aa4b2; display:grid; grid-template-columns: 1fr 1fr; gap: 8px;}
        .team-name {font-weight: bold;}
        .players-box ul { padding: 0; list-style-type: none; margin:0;}
        .players-left{text-align:left;} .players-right{text-align:right;}
      </style>`;

      let bodyHtml = ``;
      const byRound = {};
      state.schedule.forEach((g)=>{(byRound[g.round]??=[]).push(g);});
      Object.keys(byRound).sort((a,b)=>a-b).forEach(r => {
          bodyHtml += `<div class="card"><b>Rodada ${r}</b>`;
          byRound[r].forEach(g => {
              const teamA = state.teams[g.a];
              const teamB = state.teams[g.b];
              const playersA = `<ul>${teamA.players.map(p => `<li>${p.name}</li>`).join('')}</ul>`;
              const playersB = `<ul>${teamB.players.map(p => `<li>${p.name}</li>`).join('')}</ul>`;
              bodyHtml += `
                <div class="game">
                  <div class="mini muted" style="text-align:center; margin-bottom:4px; font-size: 7pt;">Jogo ${g.order || 1}</div>
                  <div class="game-info">
                      <span class="team-name" style="color:${teamA.color};">${teamA.name}</span>
                      <span>${g.scoreA ?? '-'} x ${g.scoreB ?? '-'}</span>
                      <span class="team-name" style="color:${teamB.color};">${teamB.name}</span>
                  </div>
                  <div class="players-box">
                    <div class="players-left">${playersA}</div>
                    <div class="players-right">${playersB}</div>
                  </div>
                </div>`;
          });
          bodyHtml += `</div>`;
      });
      return `<!DOCTYPE html><html><head><meta charset="utf-8">${style}</head><body><h1>Agenda de Jogos</h1>${bodyHtml}</body></html>`;
  }

  el("exportAgendaPdfBtn").addEventListener("click", () => {
    const fullHtml = getAgendaExportHtml();
    html2pdf().set({ margin: 10, filename: 'agenda_de_jogos.pdf', jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(fullHtml).save();
  });
  el("exportAgendaJpegBtn").addEventListener("click", () => {
    const fullHtml = getAgendaExportHtml();
    exportAsJpeg(fullHtml, 'agenda_de_jogos.jpeg', {dark: true, width: '800px'});
  });

  function distribuirPorSomaEquilibrada() {
    const sortedPlayers = [...state.players].sort((a, b) => b.skill - a.skill);
    state.teams.forEach(t => t.players = []);
    const teamSkillSums = new Array(state.numTeams).fill(0);
    sortedPlayers.forEach(player => {
        const minSumIndex = teamSkillSums.indexOf(Math.min(...teamSkillSums));
        state.teams[minSumIndex].players.push(player); teamSkillSums[minSumIndex] += player.skill;
    });
  }
  function gerarAgendaRoundRobinRespeitandoRodadas(){
    const n = state.numTeams; let list = Array.from({length:n}, (_,i)=> i);
    if(n % 2 === 1) list.push(-1);
    const m = list.length, roundsPerCycle = m - 1; let cycleRounds = [], arr = [...list];
    for(let r=0; r<roundsPerCycle; r++){
      const pairs = [];
      for(let i=0; i<m/2; i++){ if(arr[i]!==-1&&arr[m-1-i]!==-1) pairs.push({a:arr[i],b:arr[m-1-i]}); }
      cycleRounds.push(pairs); const fixed = arr[0], rest = arr.slice(1);
      rest.unshift(rest.pop()); arr = [fixed, ...rest];
    }
    const wantedRounds = state.numRounds; let rounds = [];
    for(let k=0; rounds.length<wantedRounds; k++){
      for(const rr of cycleRounds){ rounds.push(rr.map(p=>({...p}))); if(rounds.length>=wantedRounds) break; }
    }
    state.schedule = [];
    for(let r=0; r<rounds.length; r++){
      let order = 1; for(const p of rounds[r]){ state.schedule.push({ a:p.a, b:p.b, scoreA:null, scoreB:null, round:r+1, order:order++ }); }
    }
    state.currentIndex = 0;
  }
  function teamChip(t){
    const totalSkill = t.players.reduce((s,p)=>s + p.skill, 0);
    return `<span class="chip"><span class="dot" style="background:${t.color}"></span><b style="color:${t.color}">${t.name} (${totalSkill}‚≠ê)</b></span>`;
  }
  function renderPlayersList(players){
    if(!players||!players.length) return `<div class="players-list"><ul><li><em class="mini muted">Sem jogadores</em></li></ul></div>`;
    return `<div class="players-list"><ul>${[...players].sort((a,b)=>a.name.localeCompare(b.name)).map(p=>`<li>${p.name} (${p.skill}‚≠ê)</li>`).join("")}</ul></div>`;
  }
  const attachScoreButtonListeners = (containerSelector, scoreA_id, scoreB_id) => {
    const container = document.querySelector(containerSelector); if (!container) return;
    container.querySelectorAll('button[data-op]').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetInput = el(btn.dataset.target === 'scoreA' ? scoreA_id : scoreB_id); if (!targetInput) return;
        let value = parseInt(targetInput.value, 10) || 0;
        if (btn.dataset.op === 'plus') value++; else if (btn.dataset.op === 'minus' && value > 0) value--;
        targetInput.value = value;
      });
    });
  };
  function renderCurrentMatch(){
    const g=state.schedule[state.currentIndex]; if(!g)return; const A=state.teams[g.a], B=state.teams[g.b];
    el("roundInfo").innerText = `Rodada ${g.round} ‚Äî Jogo ${g.order}`;
    el("currentMatch").innerHTML = `<div class="score-grid"><div class="team-side"><div>${teamChip(A)}</div>${renderPlayersList(A.players)}</div><div class="vs">vs</div><div class="team-side" style="align-items:flex-end"><div>${teamChip(B)}</div>${renderPlayersList(B.players)}</div></div><div style="margin-top:12px" class="row cols-2"><div><label>Pontos ‚Äî ${A.name}</label><div class="score-input-group"><button class="secondary" data-op="minus" data-target="scoreA">-</button><input id="scoreA" type="number" min="0" placeholder="0" value="${g.scoreA ?? ''}"/><button class="secondary" data-op="plus" data-target="scoreA">+</button></div></div><div><label>Pontos ‚Äî ${B.name}</label><div class="score-input-group"><button class="secondary" data-op="minus" data-target="scoreB">-</button><input id="scoreB" type="number" min="0" placeholder="0" value="${g.scoreB ?? ''}"/><button class="secondary" data-op="plus" data-target="scoreB">+</button></div></div></div>`;
    attachScoreButtonListeners('#currentMatch', 'scoreA', 'scoreB');
    el('nextMatchBtn').disabled = g.scoreA === null;
  }
  function atualizarClassificacao(){
    state.teams.forEach(t=> t.stats={J:0,V:0,D:0,PF:0,PS:0});
    state.schedule.forEach(g=>{ if(g.scoreA==null||g.scoreB==null)return; const A=state.teams[g.a], B=state.teams[g.b]; A.stats.J++; B.stats.J++; A.stats.PF+=g.scoreA; A.stats.PS+=g.scoreB; B.stats.PF+=g.scoreB; B.stats.PS+=g.scoreA; if(g.scoreA > g.scoreB){A.stats.V++;B.stats.D++;}else if(g.scoreB > g.scoreA){B.stats.V++;A.stats.D++;}});
    el("standingsTable").querySelector("tbody").innerHTML = state.teams
      .map(t=>{ const saldo=t.stats.PF - t.stats.PS; const perc=t.stats.J?Math.round((t.stats.V/t.stats.J)*1000)/10:0; return {...t, ...t.stats, saldo, perc}; })
      .sort((a,b)=> (b.V - a.V) || (b.saldo - a.saldo) || (b.PF - a.PF))
      .map(r=>`<tr><td style="color:${r.color}; font-weight:700;">${r.name}</td><td class="right">${r.J}</td><td class="right">${r.V}</td><td class="right">${r.D}</td><td class="right">${r.PF}</td><td class="right">${r.PS}</td><td class="right">${r.saldo}</td><td class="right">${r.perc}%</td></tr>`).join("");
  }
  el("saveOnlyBtn").addEventListener("click", ()=>{
    const g = state.schedule[state.currentIndex]; if (!g) return;
    const a=parseInt(el("scoreA").value,10), b=parseInt(el("scoreB").value,10);
    if(isNaN(a)||isNaN(b)){alert("Digite os pontos.");return;} 
    g.scoreA=a;g.scoreB=b;
    atualizarClassificacao(); renderAgenda(); 
    el('nextMatchBtn').disabled = false;
    saveState();
  });
  el("nextMatchBtn").addEventListener("click", ()=>{
    state.currentIndex++;
    if (state.currentIndex >= state.schedule.length) { iniciarFinais(); } 
    else { renderCurrentMatch(); }
    saveState();
  });
  function renderAgenda(){
    const container=el("agenda"); container.innerHTML = ""; const byRound={};
    state.schedule.forEach((g,idx)=>{(byRound[g.round]??=[]).push({...g,idx});});
    Object.keys(byRound).sort((a,b)=>a-b).forEach(r=>{
      const wrap=document.createElement("div"); wrap.className="card"; wrap.style.marginBottom="8px";
      wrap.innerHTML=`<b>Rodada ${r}</b>`+byRound[r].sort((x,y)=>(x.order||1)-(y.order||1)).map(g=>{ 
        const A=state.teams[g.a], B=state.teams[g.b];
        return `<div id="game-row-${g.idx}" class="agenda-game">
                  <div class="mini muted" style="text-align:center; margin-bottom:4px;">Jogo ${g.order || 1}</div>
                  <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                    ${teamChip(A)}
                    <span class="kbd">${g.scoreA ?? '-'}</span>:<span class="kbd">${g.scoreB ?? '-'}</span>
                    ${teamChip(B)}
                  </div>
                  <div style="text-align:center; margin-top: 8px;">
                    <button class="small secondary" data-edit="${g.idx}">Editar</button>
                  </div>
                </div>`;
      }).join("");
      container.appendChild(wrap);
    });
  }
  el("agenda").addEventListener("click", e => {
    if (e.target.matches('button[data-edit]')) { 
        const idx=parseInt(e.target.dataset.edit,10);
        if (el(`editor-${idx}`)) return;
        const game=state.schedule[idx]; 
        const editorHtml = `<div class="game-editor" id="editor-${idx}"><input type="number" value="${game.scoreA??0}" id="edit-scoreA-${idx}"/><input type="number" value="${game.scoreB??0}" id="edit-scoreB-${idx}"/><button class="small" data-save="${idx}">Salvar</button></div>`; 
        e.target.closest('.agenda-game').insertAdjacentHTML('beforeend', editorHtml);
        e.target.parentElement.style.display = 'none';
    }
    if (e.target.matches('button[data-save]')) { const idx=parseInt(e.target.dataset.save,10); const game=state.schedule[idx]; const a=parseInt(el(`edit-scoreA-${idx}`).value,10), b=parseInt(el(`edit-scoreB-${idx}`).value,10); if(isNaN(a)||isNaN(b)){alert("Valores inv√°lidos.");return;} game.scoreA=a;game.scoreB=b; atualizarClassificacao();renderAgenda(); if(state.currentIndex===idx){el("scoreA").value=a;el("scoreB").value=b;} saveState(); }
  });
  el("backToMatchesBtn").addEventListener("click", () => { el('finals').classList.add('hidden'); el('matches').classList.remove('hidden'); saveState(); });
  el("backToFinalsBtn").addEventListener("click", () => { el('podium').classList.add('hidden'); el('finals').classList.remove('hidden'); saveState(); });
  
  function iniciarFinais(){
    atualizarClassificacao();
    const ranking = state.teams.map((t,i)=>({ i, name:t.name, color:t.color, players:t.players, stats:{...t.stats} })).sort((a,b)=> (b.stats.V - a.stats.V) || ((b.stats.PF - b.stats.PS) - (a.stats.PF - a.stats.PS)) || (b.stats.PF - a.stats.PF));
    state.finals = [];
    if (ranking.length >= 4) {
        state.finals.push({ label:"3¬∫ lugar", a:ranking[2].i, b:ranking[3].i });
        state.finals.push({ label:"Final", a:ranking[0].i, b:ranking[1].i }); 
    } else if (ranking.length >= 2) {
        state.finals.push({ label:"Final", a:ranking[0].i, b:ranking[1].i }); 
    } else { 
        alert("Times insuficientes para finais."); buildPodium(); 
        el('matches').classList.add('hidden'); el('podium').classList.remove('hidden'); saveState(); return; 
    }
    state.finals.forEach(f => { f.scoreA = null; f.scoreB = null; });
    state._rankingSnapshot = ranking; state.finalsIndex = 0;
    el('matches').classList.add('hidden');
    el('finals').classList.remove('hidden');
    renderFinalMatch();
    saveState();
  }
  function renderFinalMatch(){
    const f=state.finals[state.finalsIndex]; if(!f){buildPodium();return;} const A=state.teams[f.a], B=state.teams[f.b];
    el("finalsMatch").innerHTML=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><div>${teamChip(A)}</div><div class="mini muted">${f.label}</div><div>${teamChip(B)}</div></div><div style="margin-top:10px" class="row cols-2"><div><label>Pontos ‚Äî ${A.name}</label><div class="score-input-group"><button class="secondary" data-op="minus" data-target="scoreA">-</button><input id="fscoreA" type="number" min="0" value="${f.scoreA??''}"><button class="secondary" data-op="plus" data-target="scoreA">+</button></div></div><div><label>Pontos ‚Äî ${B.name}</label><div class="score-input-group"><button class="secondary" data-op="minus" data-target="scoreB">-</button><input id="fscoreB" type="number" min="0" value="${f.scoreB??''}"><button class="secondary" data-op="plus" data-target="scoreB">+</button></div></div></div></div>`;
    attachScoreButtonListeners('#finalsMatch', 'fscoreA', 'fscoreB');
  }
  el("saveFinalBtn").addEventListener("click", ()=>{
    const f=state.finals[state.finalsIndex]; if(!f) return;
    const a=parseInt(el("fscoreA").value,10), b=parseInt(el("fscoreB").value,10);
    if(isNaN(a)||isNaN(b)){alert("Digite os pontos.");return;} f.scoreA=a; f.scoreB=b; state.finalsIndex++;
    if(state.finalsIndex >= state.finals.length){ buildPodium(); el('finals').classList.add('hidden'); el('podium').classList.remove('hidden'); } else { renderFinalMatch(); }
    saveState();
  });
  function getPlayerList(team) {
    if (!team || !team.players || team.players.length === 0) return '';
    return ` (${team.players.map(p => p.name).join(', ')})`;
  };
  function buildPodium(){
    let podiumHTML = '';
    const placedTeamNames = new Set();
    const finalGame=state.finals.find(x=>x.label==="Final");
    const thirdGame=state.finals.find(x=>x.label.includes("3¬∫"));
    const getWinner = f => f&&f.scoreA!=null&&f.scoreB!=null?(f.scoreA>f.scoreB?state.teams[f.a]:state.teams[f.b]):null;
    const getLoser = f => f&&f.scoreA!=null&&f.scoreB!=null?(f.scoreA<f.scoreB?state.teams[f.a]:state.teams[f.b]):null;
    
    const champion = getWinner(finalGame);
    const runnerup = getLoser(finalGame);
    const third = getWinner(thirdGame);
    const fourth = getLoser(thirdGame);

    if (champion) { podiumHTML += `<div class="status good"><b>üèÜ 1¬∫ LUGAR:</b> ${champion.name}</div>`; placedTeamNames.add(champion.name); }
    if (runnerup) { podiumHTML += `<div class="status"><b>ü•à 2¬∫ LUGAR:</b> ${runnerup.name}</div>`; placedTeamNames.add(runnerup.name); }
    if (third) { podiumHTML += `<div class="status"><b>ü•â 3¬∫ LUGAR:</b> ${third.name}</div>`; placedTeamNames.add(third.name); }
    if (fourth) { podiumHTML += `<div class="status"><b>4¬∫ LUGAR:</b> ${fourth.name}</div>`; placedTeamNames.add(fourth.name); }
    
    if (state._rankingSnapshot) {
      let rank = placedTeamNames.size + 1;
      state._rankingSnapshot.forEach(teamData => {
        if (!placedTeamNames.has(teamData.name)) {
            podiumHTML += `<div class="status"><b>${rank}¬∫ LUGAR:</b> ${teamData.name}</div>`;
            placedTeamNames.add(teamData.name);
            rank++;
        }
      });
    }
    el("podiumBox").innerHTML = podiumHTML || '<div class="status">P√≥dio indispon√≠vel.</div>';
  }
  
  function getFullReportHtml(){
    const styleBlock = `<style>
      body{font-family: Inter, sans-serif; background: #fff; color: #000; font-size: 9pt;}
      h1,h2{font-family:Inter,sans-serif; color: #000;}
      h1{font-size: 16pt; text-align:center; margin-bottom: 20px;} h2{font-size: 12pt; margin-top: 16px;}
      .report-card{background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; padding:12px; margin-bottom: 12px; page-break-inside: avoid;}
      .right{text-align:right;} .mini{font-size:0.8rem; color:#6c757d;} 
      .kbd{font-family:monospace; background:#e9ecef; padding:2px 4px; border-radius:4px; border:1px solid #ced4da; color: #000 !important;}
      .chip b { color: #000 !important; }
      .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border-radius:999px;background:#e9ecef;border:1px solid #ced4da;}
      .dot{width:10px;height:10px;border-radius:50%;}
      .agenda-game{border-bottom: 1px solid #dee2e6; padding: 6px 0; margin-bottom: 6px;} .agenda-game:last-child{border-bottom:0;}
      .report-card > div > .card > b {display:block; font-size: 10pt; background: #e9ecef; color: #000 !important; font-weight: bold; padding: 5px; margin: -12px -12px 8px -12px; border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;}
      table{width:100%;border-collapse:collapse;page-break-inside: avoid; font-size: 8pt; text-align:center;} 
      td:first-child{text-align:left;}
      th,td{padding:5px;border:1px solid #ccc;} 
      th{background:#e9ecef; color: #000 !important; font-weight: bold;}
      .status{padding:8px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; margin-bottom:6px; page-break-inside: avoid;}
      .status b, .status span, .status div {color: #000 !important;}
      .status.gold{background-color: #fcf6e4; border-color: #f7d995;}
      .status.silver{background-color: #f1f3f5; border-color: #dee2e6;}
      .status.bronze{background-color: #fcefe7; border-color: #f3d1b9;}
      .finals-game{padding:4px 0; margin-bottom: 10px;}
    </style>`;
    
    const agendaClone = el("agenda").cloneNode(true);
    agendaClone.querySelectorAll('button[data-edit]').forEach(btn => btn.parentElement.remove());
    agendaClone.querySelectorAll('*').forEach(elem => { if(elem.style.color) elem.style.color = '#000'; });
    const agendaHTML = `<div class="report-card"><h2>Agenda</h2><div>${agendaClone.innerHTML}</div></div>`;
    
    const rankingData = state._rankingSnapshot || [];
    const sortedTeams = [...rankingData].sort((a,b)=> (b.stats.V - a.stats.V) || ((b.stats.PF - b.stats.PS) - (a.stats.PF - a.stats.PS)) || (b.stats.PF - a.stats.PF));
    const standingsBodyHTML = sortedTeams.map(r=>{
        const team = state.teams.find(t => t.name === r.name) || r;
        const stats = team.stats;
        const saldo = stats.PF - stats.PS;
        const perc = stats.J ? Math.round((stats.V / stats.J) * 1000) / 10 : 0;
        return `<tr><td style="color:${team.color}; font-weight:700;">${team.name}</td><td class="right">${stats.J}</td><td class="right">${stats.V}</td><td class="right">${stats.D}</td><td class="right">${stats.PF}</td><td class="right">${stats.PS}</td><td class="right">${saldo}</td><td class="right">${perc}%</td></tr>`;
    }).join("");
    const standingsHTML = `<div class="report-card"><h2>Classifica√ß√£o das Rodadas</h2><table><thead><tr><th>Time</th><th class="right">J</th><th class="right">V</th><th class="right">D</th><th class="right">PF</th><th class="right">PS</th><th class="right">Saldo</th><th class="right">% de vit√≥ria</th></tr></thead><tbody>${standingsBodyHTML}</tbody></table></div>`;
    
    const finalsHTML = state.finals.length>0?`<div class="report-card"><h2>Finais</h2><div>${state.finals.map(f=>{const A=state.teams[f.a],B=state.teams[f.b];return `<div class="finals-game"><b>${f.label}:</b> <span style="color:${A.color};">${A.name}</span> <b>(${f.scoreA??"-"})</b> x <b>(${f.scoreB??"-"})</b> <span style="color:${B.color};">${B.name}</span></div>`;}).join('')}</div></div>`:'';
    
    const getPlayerListForPDF = (team) => {
        if (!team || !team.players || !team.players.length === 0) return '';
        return ` (${team.players.map(p => p.name).join(', ')})`;
    };
    
    const podiumClone = document.createElement('div');
    buildPodium();
    podiumClone.innerHTML = el("podiumBox").innerHTML;
    podiumClone.querySelectorAll('*').forEach(elem => { elem.style.color = '#000' });
    podiumClone.querySelectorAll('div.status').forEach((div) => {
        const bTag = div.querySelector('b');
        if (bTag && bTag.nextSibling && bTag.nextSibling.nodeType === Node.TEXT_NODE) {
            const teamName = bTag.nextSibling.textContent.trim();
            if (teamName && teamName !== '-') {
                const team = state.teams.find(t => t.name === teamName);
                if (team) {
                    bTag.nextSibling.textContent = ` ${teamName}${getPlayerListForPDF(team)}`;
                }
            }
        }
    });
    const podiumSts = podiumClone.querySelectorAll('div.status');
    if (podiumSts.length > 0) podiumSts[0]?.classList.add('gold');
    if (podiumSts.length > 1) podiumSts[1]?.classList.add('silver');
    if (podiumSts.length > 2) podiumSts[2]?.classList.add('bronze');
    const podiumHTML = `<div class="report-card"><h2>P√≥dio</h2>` + (podiumClone.innerHTML || "<div>P√≥dio pendente.</div>") + `</div>`;

    const wrapperHTML = `<body><h1>Peladas Vale no V√¥lei ‚Äî Relat√≥rio</h1>${agendaHTML}${standingsHTML}${finalsHTML}${podiumHTML}</body>`;
    
    return `<!DOCTYPE html><html><head><meta charset="utf-8">${styleBlock}</head>${wrapperHTML}</html>`;
  }

  el("exportFullPdfBtn").addEventListener("click", ()=>{
    const fullHtml = getFullReportHtml();
    html2pdf().set({
        margin: 10, filename: 'relatorio_completo_volei.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'avoid-all'] }
    }).from(fullHtml).save();
  });
  el("exportFullJpegBtn").addEventListener("click", () => {
    const fullHtml = getFullReportHtml();
    exportAsJpeg(fullHtml, 'relatorio_completo.jpeg', {dark: false, width: '800px'});
  });

  loadState();
})();
</script>
</body>
</html>